# Документация API для системы Bluetooth навигации в помещениях

## Общая информация

API системы Bluetooth навигации в помещениях предоставляет интерфейс для мобильного приложения для получения данных о местоположении, построения маршрутов и получения информации о помещениях и точках интереса.

- Базовый URL: `https://your-server.com/api/v1/`
- Формат данных: JSON
- Кодировка: UTF-8
- Аутентификация: JWT токены (где указано)

## Структура ответов

Все ответы API следуют стандартной структуре:

```json
{
  "status": "success",
  "data": {},
  "timestamp": "2023-12-02T10:30:00Z"
}
```

Или в случае ошибки:

```json
{
  "status": "error",
  "error": "Описание ошибки",
  "timestamp": "2023-12-02T10:30:00Z"
}
```

## Методы API

### 1. Проверка состояния сервера

#### GET /health

Проверяет работоспособность сервера.

##### Пример запроса:
```
GET /api/v1/health
```

##### Пример ответа:
```json
{
  "status": "success",
  "data": {
    "status": "OK",
    "timestamp": "2023-12-02T10:30:00Z",
    "service": "BLE Indoor Navigation Backend"
  },
  "timestamp": "2023-12-02T10:30:00Z"
}
```

### 2. Определение местоположения

#### POST /location

Определяет местоположение пользователя на основе данных от BLE-маячков.

##### Заголовки:
- Content-Type: application/json

##### Тело запроса:
```json
{
  "beacons": [
    {
      "uuid": "123e4567-e89b-12d3-a456-426614174000",
      "major": 1,
      "minor": 1,
      "rssi": -65,
      "txPower": -59
    },
    {
      "uuid": "123e4567-e89b-12d3-a456-426614174001",
      "major": 1,
      "minor": 2,
      "rssi": -70,
      "txPower": -59
    },
    {
      "uuid": "123e4567-e89b-12d3-a456-426614174002",
      "major": 1,
      "minor": 3,
      "rssi": -75,
      "txPower": -59
    }
  ],
  "userId": "user123"
}
```

##### Параметры:
- `beacons` (массив, обязательный): Массив объектов маячков с данными
  - `uuid` (строка, обязательный): UUID маячка
  - `major` (число): Major значение
  - `minor` (число): Minor значение
  - `rssi` (число, обязательный): Уровень сигнала
  - `txPower` (число): Мощность передатчика (по умолчанию -59)
- `userId` (строка): Идентификатор пользователя

##### Пример ответа:
```json
{
  "status": "success",
  "data": {
    "location": {
      "x": 7.5,
      "y": 8.2
    },
    "accuracy": 2.1,
    "timestamp": "2023-12-02T10:30:00Z"
  },
  "timestamp": "2023-12-02T10:30:00Z"
}
```

##### Возможные ошибки:
- 400: Недостаточно данных от маячков
- 500: Ошибка вычисления местоположения

### 3. Построение маршрута

#### GET /route

Строит маршрут между двумя точками в помещении.

##### Параметры запроса:
- `start_x` (число, обязательный): X-координата начальной точки
- `start_y` (число, обязательный): Y-координата начальной точки
- `end_x` (число, обязательный): X-координата конечной точки
- `end_y` (число, обязательный): Y-координата конечной точки
- `roomId` (строка): ID помещения

##### Пример запроса:
```
GET /api/v1/route?start_x=5&start_y=5&end_x=15&end_y=10&roomId=room1
```

##### Пример ответа:
```json
{
  "status": "success",
  "data": {
    "route": [
      {"x": 5, "y": 5},
      {"x": 7, "y": 6},
      {"x": 10, "y": 8},
      {"x": 15, "y": 10}
    ],
    "distance": 15.7,
    "estimated_time": 11.2,
    "timestamp": "2023-12-02T10:30:00Z"
  },
  "timestamp": "2023-12-02T10:30:00Z"
}
```

##### Возможные ошибки:
- 400: Отсутствуют обязательные параметры
- 404: Маршрут не найден
- 404: Граф помещения не найден

### 4. Получение точек интереса

#### GET /poi

Получает точки интереса в помещении.

##### Параметры запроса:
- `roomId` (строка): ID помещения
- `type` (строка): Тип точки интереса (cafe, restroom, exit и т.д.)

##### Пример запроса:
```
GET /api/v1/poi?roomId=room1&type=cafe
```

##### Пример ответа:
```json
{
  "status": "success",
  "data": {
    "pois": [
      {
        "id": 1,
        "name": "Кафе",
        "x": 6.0,
        "y": 6.0,
        "type": "cafe"
      },
      {
        "id": 2,
        "name": "Кафе 2",
        "x": 12.0,
        "y": 8.0,
        "type": "cafe"
      }
    ],
    "count": 2,
    "timestamp": "2023-12-02T10:30:00Z"
  },
  "timestamp": "2023-12-02T10:30:00Z"
}
```

### 5. Получение информации о помещениях

#### GET /rooms

Получает список всех помещений.

##### Пример запроса:
```
GET /api/v1/rooms
```

##### Пример ответа:
```json
{
  "status": "success",
  "data": {
    "rooms": [
      {
        "id": 1,
        "name": "Этаж 1",
        "description": "Первый этаж здания",
        "floor_number": 1
      },
      {
        "id": 2,
        "name": "Этаж 2",
        "description": "Второй этаж здания",
        "floor_number": 2
      }
    ],
    "count": 2,
    "timestamp": "2023-12-02T10:30:00Z"
  },
  "timestamp": "2023-12-02T10:30:00Z"
}
```

### 6. Получение информации о маячках

#### GET /beacons

Получает список маячков в помещении.

##### Параметры запроса:
- `roomId` (строка): ID помещения

##### Пример запроса:
```
GET /api/v1/beacons?roomId=room1
```

##### Пример ответа:
```json
{
  "status": "success",
  "data": {
    "beacons": [
      {
        "id": 1,
        "uuid": "123e4567-e89b-12d3-a456-426614174000",
        "x": 5.0,
        "y": 5.0
      },
      {
        "id": 2,
        "uuid": "123e4567-e89b-12d3-a456-426614174001",
        "x": 10.0,
        "y": 5.0
      }
    ],
    "count": 2,
    "timestamp": "2023-12-02T10:30:00Z"
  },
  "timestamp": "2023-12-02T10:30:00Z"
}
```

## Алгоритмы

### Определение местоположения

Система использует следующие алгоритмы для определения местоположения:

1. **Расчет расстояния по RSSI**: Преобразование уровня сигнала в оценочное расстояние
2. **Трилатерация**: Определение координат на основе расстояний до 3+ маячков
3. **Многомерная трилатерация**: Улучшенная точность при наличии >3 маячков
4. **Фильтрация**: Скользящее среднее или фильтр Калмана для сглаживания данных

### Построение маршрута

Система использует алгоритм A* для построения оптимального маршрута в графе помещения.

## Безопасность

- Все API-методы, требующие аутентификации, используют JWT-токены
- Все данные передаются по HTTPS
- Валидация всех входных параметров
- Ограничение частоты запросов (rate limiting)

## Ошибки

| Код | Описание |
|-----|----------|
| 400 | Неверные параметры запроса |
| 401 | Требуется аутентификация |
| 403 | Доступ запрещен |
| 404 | Ресурс не найден |
| 429 | Слишком много запросов |
| 500 | Внутренняя ошибка сервера |